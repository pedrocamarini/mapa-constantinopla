<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Constantinopla - A Cidade do Desejo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Georgia', serif; }
        #map { height: 100vh; width: 100vw; background: #000; }

        /* Estilo dos Popups */
        .leaflet-popup-content-wrapper { 
            background: #111; color: #ccc; border: 1px solid #8a0303;
            box-shadow: 0 0 15px rgba(0,0,0,0.8); font-size: 14px; padding: 5px;
        }
        .leaflet-popup-tip { background: #111; border-top: 1px solid #8a0303; }
        .popup-title { 
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.4em; 
            display: block; border-bottom: 1px solid #444; margin-bottom: 8px;
        }
        
        /* Cores din√¢micas */
        .color-vermelho { color: #ff3333; }
        .color-azul { color: #3388ff; }
        .color-verde { color: #2ecc71; }
        .color-roxo { color: #9b59b6; }
        .color-dourado { color: #f1c40f; }
        .color-cinza { color: #95a5a6; }

        /* UI Painel */
        #auth-container { position: absolute; top: 10px; right: 10px; z-index: 1000; }
        .btn-ui { 
            background: rgba(0,0,0,0.8); color: #fff; border: 1px solid #666; 
            padding: 8px 15px; cursor: pointer; font-family: 'Cinzel', serif; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .btn-ui:hover { border-color: #ff0000; color: #ff0000; box-shadow: 0 0 10px #8a0303; }

        #dm-panel {
            position: absolute; top: 60px; right: 10px; width: 300px;
            background: #0f0f0f; padding: 20px; z-index: 1000; display: none;
            border: 1px solid #8a0303; box-shadow: 0 0 30px #000;
        }
        .dm-input { 
            width: 100%; margin-bottom: 10px; padding: 10px; background: #222; 
            border: 1px solid #444; color: #fff; box-sizing: border-box; 
        }
        select.dm-input { cursor: pointer; }
        
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; display: none; 
            justify-content: center; align-items: center;
        }
        .login-box { 
            background: #111; padding: 30px; border: 2px solid #8a0303; 
            width: 300px; text-align: center; 
        }

        /* --- NOVO ESTILO DO BOT√ÉO DELETAR --- */
        /* Agora ele fica embaixo, grande e vermelho */
        .btn-del-container {
            margin-top: 15px;
            border-top: 1px solid #333;
            padding-top: 10px;
            text-align: center;
        }
        .btn-del {
            background: #300; border: 1px solid #600; color: #f00;
            cursor: pointer; padding: 5px 15px; border-radius: 4px; font-size: 11px;
            width: 100%; font-weight: bold; text-transform: uppercase;
        }
        .btn-del:hover { background: #f00; color: white; border-color: #f00; }

    </style>
</head>
<body>

<div id="map"></div>

<div id="auth-container">
    <button id="btn-login" class="btn-ui" onclick="abrirLogin()">üíÄ Login Mestre</button>
    <button id="btn-logout" class="btn-ui" onclick="sair()" style="display:none;">Sair</button>
</div>

<div id="login-modal">
    <div class="login-box">
        <h3 style="font-family:'Cinzel'; color:#ff3333;">Dom√≠nio do Sangue</h3>
        <input type="email" id="email" class="dm-input" placeholder="Email">
        <input type="password" id="senha" class="dm-input" placeholder="Senha">
        <br><br>
        <button class="btn-ui" onclick="logar()">Entrar</button>
        <button class="btn-ui" style="border:none; background:transparent; color:#666; font-size:0.8em;" onclick="fecharLogin()">Cancelar</button>
    </div>
</div>

<div id="dm-panel">
    <h3 style="color:#ff3333; font-family:'Cinzel'; margin-top:0;">Novo Local</h3>
    <div id="coord-label" style="color:#666; font-size:0.8em; margin-bottom:10px;">Clique no mapa...</div>
    
    <input type="text" id="novo-titulo" class="dm-input" placeholder="T√≠tulo do Local">
    
    <select id="novo-cor" class="dm-input">
        <option value="vermelho">üî¥ Vermelho (Padr√£o)</option>
        <option value="azul">üîµ Azul (Nobreza/Ventrue)</option>
        <option value="verde">üü¢ Verde (Parques/Gangrel)</option>
        <option value="roxo">üü£ Roxo (Misticismo/Tremere)</option>
        <option value="dourado">üü° Dourado (Igreja/Sagrado)</option>
        <option value="cinza">‚ö´ Cinza (Esgotos/Nosferatu)</option>
    </select>

    <textarea id="novo-desc" class="dm-input" rows="3" placeholder="Descri√ß√£o"></textarea>
    <button class="btn-ui" style="width:100%" onclick="salvarPonto()">Gravar no Mapa</button>
</div>

<script>
    // --- 1. CHAVES
    const firebaseConfig = {
        apiKey: "AIzaSyAqHGUicjs2ykSIiZPBgjiROyc5TbE4YWQ",
        authDomain: "constantinopla-darkages.firebaseapp.com",
        projectId: "constantinopla-darkages",
        storageBucket: "constantinopla-darkages.firebasestorage.app",
        messagingSenderId: "193290474936",
        appId: "1:193290474936:web:f04bc7108856ef94b42b4d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. MAPA ---
    var imgWidth = 5906;
    var imgHeight = 3253;
    var url = 'mapa_final.jpg';

    var map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -2, maxZoom: 2, attributionControl: false
    });
    var bounds = [[0,0], [imgHeight, imgWidth]];
    L.imageOverlay(url, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // --- 3. GERADOR DE √çCONES ---
    function criarIcone(cor) {
        let corHex = '#ff3333';
        if (cor === 'azul') corHex = '#3388ff';
        if (cor === 'verde') corHex = '#2ecc71';
        if (cor === 'roxo') corHex = '#9b59b6';
        if (cor === 'dourado') corHex = '#f1c40f';
        if (cor === 'cinza') corHex = '#95a5a6';

        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color:${corHex}; width:14px; height:14px; border-radius:50%; border:2px solid #fff; box-shadow: 0 0 10px ${corHex};"></div>`,
            iconSize: [18, 18], iconAnchor: [9, 9], popupAnchor: [0, -10]
        });
    }

    // --- 4. L√ìGICA DO SISTEMA ---
    var currentUser = null;
    var layerPontos = L.layerGroup().addTo(map);
    var dadosLocais = []; 
    var tempLat = 0, tempLng = 0;

    // Escuta o banco de dados
    db.collection("locais").onSnapshot((snapshot) => {
        dadosLocais = [];
        snapshot.forEach((doc) => {
            dadosLocais.push({ id: doc.id, ...doc.data() });
        });
        renderizarPontos();
    });

    // Fun√ß√£o que desenha os pontos
    function renderizarPontos() {
        layerPontos.clearLayers();
        
        dadosLocais.forEach(d => {
            // Se logado, cria um bloco de HTML separado pro bot√£o
            let divBotao = currentUser ? 
                `<div class="btn-del-container"><button class="btn-del" onclick="deletar('${d.id}')">üóëÔ∏è EXCLUIR LOCAL</button></div>` 
                : "";
            
            let cor = d.cor || 'vermelho';
            
            L.marker([d.lat, d.lng], {icon: criarIcone(cor)}).addTo(layerPontos)
                .bindPopup(`
                    <span class="popup-title color-${cor}">${d.titulo}</span>
                    <div style="margin-bottom:5px;">${d.desc}</div>
                    ${divBotao}
                `);
        });
    }

    // Clique no mapa
    map.on('click', function(e){
        if(!currentUser) return;
        tempLat = Math.round(e.latlng.lat);
        tempLng = Math.round(e.latlng.lng);
        document.getElementById('dm-panel').style.display = 'block';
        document.getElementById('coord-label').innerText = `Coords: ${tempLat}, ${tempLng}`;
        document.getElementById('novo-titulo').focus();
    });

    // Salvar Ponto
    window.salvarPonto = function() {
        var tit = document.getElementById('novo-titulo').value;
        var desc = document.getElementById('novo-desc').value;
        var cor = document.getElementById('novo-cor').value;

        if(!tit) return alert("Falta o t√≠tulo!");

        db.collection("locais").add({
            lat: tempLat, lng: tempLng, titulo: tit, desc: desc, cor: cor
        }).then(() => {
            document.getElementById('dm-panel').style.display = 'none';
            document.getElementById('novo-titulo').value = "";
            document.getElementById('novo-desc').value = "";
        }).catch(err => alert("Erro ao salvar: " + err));
    }

    // Deletar Ponto (Agora global e blindado)
    window.deletar = function(id) {
        console.log("Tentando deletar: " + id);
        if(confirm("Tem certeza ABSOLUTA que quer apagar este local?")) {
            db.collection("locais").doc(id).delete()
                .then(() => alert("Local apagado com sucesso!"))
                .catch((error) => alert("Erro ao apagar: " + error));
        }
    };

    // --- 5. AUTENTICA√á√ÉO ---
    window.abrirLogin = () => document.getElementById('login-modal').style.display = 'flex';
    window.fecharLogin = () => document.getElementById('login-modal').style.display = 'none';
    
    window.logar = function() {
        var e = document.getElementById('email').value;
        var s = document.getElementById('senha').value;
        auth.signInWithEmailAndPassword(e, s).then(() => fecharLogin())
            .catch(erro => alert("Erro: " + erro.message));
    }

    window.sair = function() { 
        auth.signOut().then(() => alert("Deslogado!")); 
    }

    auth.onAuthStateChanged((user) => {
        currentUser = user;
        renderizarPontos(); // Atualiza os bot√µes de delete

        if(user) {
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'block';
            document.body.style.border = "3px solid #8a0303";
        } else {
            document.getElementById('btn-login').style.display = 'block';
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('dm-panel').style.display = 'none';
            document.body.style.border = "none";
        }
    });

</script>
</body>
</html>