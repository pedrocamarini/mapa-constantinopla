<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Constantinopla - A Cidade do Desejo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: 'Georgia', serif; }
        #map { height: 100vh; width: 100vw; background: #000; }

        /* Menu de Camadas */
        .leaflet-control-layers {
            background: #111; border: 1px solid #8a0303; color: #ccc;
            font-family: 'Cinzel', serif; border-radius: 4px;
            box-shadow: 0 0 10px #000; margin-top: 10px !important;
        }
        .leaflet-control-layers-expanded { padding: 10px; background: rgba(10, 10, 10, 0.95); }

        /* Popups */
        .leaflet-popup-content-wrapper { 
            background: #111; color: #ccc; border: 1px solid #8a0303;
            box-shadow: 0 0 15px rgba(0,0,0,0.9); font-size: 14px; padding: 0; overflow: hidden;
        }
        .leaflet-popup-content { margin: 12px; }
        .leaflet-popup-tip { background: #111; border-top: 1px solid #8a0303; }
        .popup-title { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.4em; display: block; border-bottom: 1px solid #444; margin-bottom: 8px; }
        .popup-img { width: 100%; height: auto; display: block; max-height: 200px; object-fit: cover; border-radius: 4px; margin-top: 10px; }

        /* Cores */
        .color-vermelho { color: #ff3333; }
        .color-azul { color: #3388ff; }
        .color-verde { color: #2ecc71; }
        .color-roxo { color: #9b59b6; }
        .color-dourado { color: #f1c40f; }
        .color-cinza { color: #95a5a6; }

        /* √çcones */
        .custom-div-icon { background: transparent; border: none; }
        .map-icon-inner {
            display: flex; justify-content: center; align-items: center;
            width: 24px; height: 24px; background: #1a1a1a; border-radius: 50%;
            border: 2px solid #fff; box-shadow: 0 0 8px currentColor; font-size: 12px;
        }

        /* UI Geral */
        #auth-container { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 10px; }
        
        .btn-ui { 
            background: rgba(0,0,0,0.9); color: #d4af37; border: 1px solid #8a0303; 
            padding: 8px 15px; cursor: pointer; font-family: 'Cinzel', serif; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; font-size: 12px;
        }
        .btn-ui:hover { background: #8a0303; color: #fff; box-shadow: 0 0 15px #8a0303; }
        
        /* Pain√©is */
        #dm-panel {
            position: absolute; top: 60px; right: 10px; width: 300px;
            background: #0f0f0f; padding: 20px; z-index: 1000; display: none;
            border: 1px solid #8a0303; box-shadow: 0 0 30px #000;
        }
        #poly-panel {
            position: absolute; top: 60px; right: 10px; width: 250px;
            background: #1a0505; padding: 15px; z-index: 1001; display: none;
            border: 2px solid #ff3333; box-shadow: 0 0 30px #000;
        }
        #poly-status { color: #ccc; font-size: 12px; margin-bottom: 10px; text-align: center; }
        
        .close-panel { position: absolute; top: 10px; right: 15px; color: #666; cursor: pointer; font-size: 18px; }
        .dm-input { width: 100%; margin-bottom: 10px; padding: 10px; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box; }
        
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; display: none; 
            justify-content: center; align-items: center;
        }
        .login-box { background: #111; padding: 30px; border: 2px solid #8a0303; width: 300px; text-align: center; }
        
        .btn-del-container { margin-top: 15px; border-top: 1px solid #333; padding-top: 10px; text-align: center; }
        .btn-del {
            background: #300; border: 1px solid #600; color: #f00; width: 100%;
            cursor: pointer; padding: 5px 15px; border-radius: 4px; font-size: 11px; font-weight: bold;
        }
        .btn-del:hover { background: #f00; color: white; border-color: #f00; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="auth-container">
    <button id="btn-draw" class="btn-ui" onclick="iniciarDesenho()" style="display:none;">‚¨† Novo Territ√≥rio</button>
    <button id="btn-login" class="btn-ui" onclick="abrirLogin()">üíÄ Login</button>
    <button id="btn-logout" class="btn-ui" onclick="sair()" style="display:none;">Sair</button>
</div>

<div id="login-modal">
    <div class="login-box">
        <h3 style="font-family:'Cinzel'; color:#ff3333;">Dom√≠nio do Sangue</h3>
        <input type="email" id="email" class="dm-input" placeholder="Email">
        <input type="password" id="senha" class="dm-input" placeholder="Senha">
        <br><br>
        <button class="btn-ui" onclick="logar()">Entrar</button>
        <button class="btn-ui" style="border:none; background:transparent; color:#666;" onclick="fecharLogin()">Cancelar</button>
    </div>
</div>

<div id="dm-panel">
    <span class="close-panel" onclick="fecharPainel()">‚úï</span>
    <h3 style="color:#ff3333; font-family:'Cinzel'; margin-top:0;">Novo Local</h3>
    <input type="text" id="novo-titulo" class="dm-input" placeholder="T√≠tulo">
    <input type="text" id="novo-img" class="dm-input" placeholder="Link da Imagem (URL)">
    <select id="novo-cor" class="dm-input"><option value="vermelho">üî¥ Vermelho</option><option value="azul">üîµ Azul</option><option value="verde">üü¢ Verde</option><option value="roxo">üü£ Roxo</option><option value="dourado">üü° Dourado</option><option value="cinza">‚ö´ Cinza</option></select>
    <select id="novo-tipo" class="dm-input"><option value="padrao">üìç Padr√£o</option><option value="cruz">‚úùÔ∏è Templo</option><option value="lapide">ü™¶ Cemit√©rio</option><option value="mercado">üí∞ Mercado</option><option value="governo">üèõÔ∏è Governo</option><option value="livro">üìñ Biblioteca</option><option value="coroa">üëë Nobreza</option><option value="ancora">‚öì Porto</option><option value="taverna">üç∫ Taverna</option><option value="sangue">ü©∏ Ref√∫gio</option></select>
    <textarea id="novo-desc" class="dm-input" rows="3" placeholder="Descri√ß√£o"></textarea>
    <button class="btn-ui" style="width:100%" onclick="salvarPonto()">Gravar Local</button>
</div>

<div id="poly-panel">
    <h3 style="color:#ff3333; font-family:'Cinzel'; margin:0 0 10px 0;">Desenhando...</h3>
    <div id="poly-status">Clique no mapa para tra√ßar.</div>
    
    <input type="text" id="poly-titulo" class="dm-input" placeholder="Nome do Territ√≥rio">
    <select id="poly-cor" class="dm-input" onchange="atualizarPreviewCor()"><option value="vermelho">üî¥ Vermelho</option><option value="azul">üîµ Azul</option><option value="verde">üü¢ Verde</option><option value="roxo">üü£ Roxo</option><option value="dourado">üü° Dourado</option><option value="cinza">‚ö´ Cinza</option></select>
    <textarea id="poly-desc" class="dm-input" rows="2" placeholder="Descri√ß√£o"></textarea>
    
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="btn-ui" style="flex:1; background:#444;" onclick="desfazerUltimoPonto()">‚Ü© Desfazer</button>
        <button id="btn-gravar-poly" class="btn-ui" style="flex:1;" onclick="salvarTerritorio()">üíæ GRAVAR</button>
    </div>
    <button class="btn-ui" style="width:100%; background:#333; border-color:#666;" onclick="cancelarDesenho()">Cancelar Tudo</button>
</div>

<script>
    // --- CHAVE DA API ---
    const firebaseConfig = {
        apiKey: "AIzaSyAqHGUicjs2ykSIiZPBgjiROyc5TbE4YWQ", 
        authDomain: "constantinopla-darkages.firebaseapp.com",
        projectId: "constantinopla-darkages",
        storageBucket: "constantinopla-darkages.firebasestorage.app",
        messagingSenderId: "193290474936",
        appId: "1:193290474936:web:f04bc7108856ef94b42b4d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- MAPA ---
    var imgWidth = 5906;
    var imgHeight = 3253;
    var url = 'mapa_final.jpg';

    var map = L.map('map', {
        crs: L.CRS.Simple, minZoom: -2, maxZoom: 2, attributionControl: false
    });
    var bounds = [[0,0], [imgHeight, imgWidth]];
    L.imageOverlay(url, bounds).addTo(map);
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // --- CAMADAS ---
    var layers = {
        "Territ√≥rios": L.layerGroup().addTo(map),
        "Outros": L.layerGroup().addTo(map),
        "Religi√£o (Cruz)": L.layerGroup().addTo(map),
        "Mortos (L√°pide)": L.layerGroup().addTo(map),
        "Com√©rcio (Mercado)": L.layerGroup().addTo(map),
        "Pol√≠tica": L.layerGroup().addTo(map),
        "Conhecimento": L.layerGroup().addTo(map),
        "Naval": L.layerGroup().addTo(map),
        "Social": L.layerGroup().addTo(map),
        "Sangue": L.layerGroup().addTo(map)
    };
    L.control.layers(null, layers, { collapsed: true, position: 'topleft' }).addTo(map);

    // --- CORES & √çCONES ---
    function getHexCor(cor) {
        if (cor === 'azul') return '#3388ff';
        if (cor === 'verde') return '#2ecc71';
        if (cor === 'roxo') return '#9b59b6';
        if (cor === 'dourado') return '#f1c40f';
        if (cor === 'cinza') return '#95a5a6';
        return '#ff3333';
    }

    function criarIcone(cor, tipo) {
        let hex = getHexCor(cor);
        let iconClass = 'fa-circle';
        if (tipo === 'cruz') iconClass = 'fa-cross';
        if (tipo === 'lapide') iconClass = 'fa-skull';
        if (tipo === 'mercado') iconClass = 'fa-coins';
        if (tipo === 'governo') iconClass = 'fa-landmark';
        if (tipo === 'livro') iconClass = 'fa-book';
        if (tipo === 'coroa') iconClass = 'fa-crown';
        if (tipo === 'ancora') iconClass = 'fa-anchor';
        if (tipo === 'taverna') iconClass = 'fa-wine-glass';
        if (tipo === 'sangue') iconClass = 'fa-droplet';

        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="map-icon-inner" style="border-color:${hex}; color:${hex}; box-shadow: 0 0 8px ${hex}"><i class="fa-solid ${iconClass}"></i></div>`,
            iconSize: [24, 24], iconAnchor: [12, 12], popupAnchor: [0, -15]
        });
    }

    // --- L√ìGICA DE DESENHO BLINDADA ---
    var modoDesenho = false;
    var pontosDesenho = [];
    var linhaTemporaria = null;
    var marcadoresTemporarios = []; 

    window.iniciarDesenho = function() {
        fecharPainel();
        modoDesenho = true;
        pontosDesenho = [];
        document.getElementById('poly-panel').style.display = 'block';
        document.getElementById('poly-status').innerText = "Clique para desenhar.";
        map.getContainer().style.cursor = 'crosshair';
    }

    window.cancelarDesenho = function() {
        modoDesenho = false;
        pontosDesenho = [];
        if(linhaTemporaria) map.removeLayer(linhaTemporaria);
        marcadoresTemporarios.forEach(m => map.removeLayer(m));
        marcadoresTemporarios = [];
        document.getElementById('poly-panel').style.display = 'none';
        map.getContainer().style.cursor = '';
    }
    
    window.desfazerUltimoPonto = function() {
        if(pontosDesenho.length > 0) {
            pontosDesenho.pop();
            redesenharLinhaTemporaria();
            let ultimaBolinha = marcadoresTemporarios.pop();
            if(ultimaBolinha) map.removeLayer(ultimaBolinha);
            document.getElementById('poly-status').innerText = `${pontosDesenho.length} pontos marcados.`;
        }
    }

    window.atualizarPreviewCor = function() {
        if(linhaTemporaria) {
            let cor = document.getElementById('poly-cor').value;
            linhaTemporaria.setStyle({ color: getHexCor(cor) });
        }
    }
    
    function redesenharLinhaTemporaria() {
        if(linhaTemporaria) map.removeLayer(linhaTemporaria);
        let cor = document.getElementById('poly-cor').value;
        linhaTemporaria = L.polyline(pontosDesenho, { color: getHexCor(cor), weight: 3, dashArray: '5, 10' }).addTo(map);
    }

    map.on('click', function(e){
        if(!currentUser) return;

        // MODO DESENHO
        if(modoDesenho) {
            let lat = e.latlng.lat;
            let lng = e.latlng.lng;
            pontosDesenho.push([lat, lng]);
            redesenharLinhaTemporaria();
            let bolinha = L.circleMarker([lat, lng], { radius: 4, color: '#fff', fillOpacity: 1 }).addTo(map);
            marcadoresTemporarios.push(bolinha);
            document.getElementById('poly-status').innerText = `${pontosDesenho.length} pontos marcados.`;
            return;
        }

        // MODO PINO
        tempLat = Math.round(e.latlng.lat);
        tempLng = Math.round(e.latlng.lng);
        document.getElementById('dm-panel').style.display = 'block';
        document.getElementById('novo-titulo').focus();
    });

    // --- FUN√á√ÉO DE SALVAR CORRIGIDA ---
    window.salvarTerritorio = async function() {
        try {
            if(pontosDesenho.length < 3) return alert("Marque pelo menos 3 pontos.");
            
            let tit = document.getElementById('poly-titulo').value || "Territ√≥rio Sem Nome";
            let cor = document.getElementById('poly-cor').value;
            let desc = document.getElementById('poly-desc').value || "";

            // Limpa os dados para garantir que s√£o n√∫meros
            let pontosLimpos = pontosDesenho.map(p => [Number(p[0]), Number(p[1])]);

            // SELECIONA O BOT√ÉO PELO ID (A CORRE√á√ÉO EST√Å AQUI!)
            let btn = document.getElementById("btn-gravar-poly");
            let txtAntigo = btn.innerText;
            btn.innerText = "Salvando...";

            await db.collection("locais").add({
                tipo: "poligono",
                pontos: pontosLimpos,
                titulo: tit,
                desc: desc,
                cor: cor
            });

            // Sucesso!
            btn.innerText = txtAntigo;
            cancelarDesenho();

        } catch (error) {
            console.error(error);
            alert("ERRO AO SALVAR: " + error.message);
            // Se der erro, volta o texto do bot√£o
            let btn = document.getElementById("btn-gravar-poly");
            if(btn) btn.innerText = "üíæ GRAVAR";
        }
    }

    // --- RENDERIZA√á√ÉO ---
    var currentUser = null;
    var tempLat = 0, tempLng = 0;

    db.collection("locais").onSnapshot((snapshot) => {
        Object.values(layers).forEach(layer => layer.clearLayers()); // Limpa tudo
        
        snapshot.forEach((doc) => {
            let d = doc.data();
            let id = doc.id;
            let btnDel = currentUser ? `<div class="btn-del-container"><button class="btn-del" onclick="deletar('${id}')">üóëÔ∏è EXCLUIR</button></div>` : "";
            let cor = d.cor || 'vermelho';
            let hex = getHexCor(cor);
            
            if(d.tipo === 'poligono' && d.pontos) {
                // Desenha Pol√≠gono
                let poligono = L.polygon(d.pontos, {
                    color: hex, fillColor: hex, fillOpacity: 0.35, weight: 2
                });
                poligono.bindPopup(`<span class="popup-title" style="color:${hex}">${d.titulo}</span><div>${d.desc}</div>${btnDel}`);
                layers["Territ√≥rios"].addLayer(poligono);
            } else { 
                // Desenha Pino
                let tipoIcone = d.tipo || 'padrao';
                let imagemHTML = (d.imgUrl && d.imgUrl.length > 5) ? `<div class="popup-img-container"><img src="${d.imgUrl}" class="popup-img" onerror="this.style.display='none'"></div>` : "";
                
                let marcador = L.marker([d.lat, d.lng], {icon: criarIcone(cor, tipoIcone)})
                    .bindPopup(`<span class="popup-title color-${cor}">${d.titulo}</span><div>${d.desc}</div>${imagemHTML}${btnDel}`);

                // Distribui nas camadas
                let layerDestino = layers["Outros"];
                if (tipoIcone === 'cruz') layerDestino = layers["Religi√£o (Cruz)"];
                else if (tipoIcone === 'lapide') layerDestino = layers["Mortos (L√°pide)"];
                else if (tipoIcone === 'mercado') layerDestino = layers["Com√©rcio (Mercado)"];
                else if (tipoIcone === 'governo' || tipoIcone === 'coroa') layerDestino = layers["Pol√≠tica"];
                else if (tipoIcone === 'livro') layerDestino = layers["Conhecimento"];
                else if (tipoIcone === 'ancora') layerDestino = layers["Naval"];
                else if (tipoIcone === 'taverna') layerDestino = layers["Social"];
                else if (tipoIcone === 'sangue') layerDestino = layers["Sangue"];
                
                layerDestino.addLayer(marcador);
            }
        });
    });

    // UI
    window.fecharPainel = function() {
        document.getElementById('dm-panel').style.display = 'none';
        document.getElementById('novo-titulo').value = ""; document.getElementById('novo-desc').value = ""; document.getElementById('novo-img').value = "";
    }
    window.salvarPonto = function() {
        var tit = document.getElementById('novo-titulo').value;
        if(!tit) return alert("Falta o t√≠tulo!");
        db.collection("locais").add({
            lat: tempLat, lng: tempLng, titulo: tit, desc: document.getElementById('novo-desc').value, 
            imgUrl: document.getElementById('novo-img').value, cor: document.getElementById('novo-cor').value, tipo: document.getElementById('novo-tipo').value
        }).then(() => { fecharPainel(); });
    }
    window.deletar = function(id) { if(confirm("Apagar item?")) db.collection("locais").doc(id).delete(); };
    window.abrirLogin = () => document.getElementById('login-modal').style.display = 'flex';
    window.fecharLogin = () => document.getElementById('login-modal').style.display = 'none';
    window.logar = function() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('senha').value).then(() => fecharLogin()).catch(e => alert(e.message)); }
    window.sair = function() { auth.signOut().then(() => alert("Saiu!")); }

    auth.onAuthStateChanged((user) => {
        currentUser = user;
        if(user) {
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-draw').style.display = 'block';
            document.getElementById('btn-logout').style.display = 'block';
            document.body.style.border = "3px solid #8a0303";
        } else {
            document.getElementById('btn-login').style.display = 'block';
            document.getElementById('btn-draw').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('dm-panel').style.display = 'none';
            document.getElementById('poly-panel').style.display = 'none';
            document.body.style.border = "none";
        }
    });
</script>
</body>
</html>